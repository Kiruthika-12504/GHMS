@page "/misreport"
@using Syncfusion.Blazor.Grids
@inject IJSRuntime JS
@using System.Globalization

<PageTitle>MIS Report</PageTitle>

<div class="toolbar mb-3 d-flex flex-wrap align-items-center gap-2">

    <!-- Period selection -->
    <div class="d-flex gap-2 align-items-center">
        <select class="form-select" style="width:150px;" @onchange="PeriodChanged">
            <option value="All">All</option>
            <option value="Month">This Month</option>
            <option value="Year">This Year</option>
            <option value="Custom">Custom Range</option>
        </select>

        @if (IsCustomRange)
        {
            <InputDate @bind-Value="CustomStart" class="form-control" style="width:120px;" />
            <InputDate @bind-Value="CustomEnd" class="form-control" style="width:120px;" />
            <button class="btn btn-outline-primary" @onclick="ApplyCustomRange">Apply</button>
        }
        else if (IsMonthYearFilter)
        {
            <select class="form-select" style="width:140px;" @bind="SelectedMonth">
                @for (int m = 1; m <= 12; m++)
                {
                    <option value="@m">@CultureInfo.CurrentCulture.DateTimeFormat.GetMonthName(m)</option>
                }
            </select>
            <select class="form-select" style="width:100px;" @bind="SelectedYear">
                @for (int y = 2023; y <= DateTime.Now.Year + 2; y++)
                {
                    <option value="@y">@y</option>
                }
            </select>
            <button class="btn btn-outline-primary" @onclick="ApplyMonthYearFilter">Apply</button>
        }
    </div>

<!-- Search and Actions (inline with export buttons) -->
<div class="d-flex gap-2 align-items-center flex-grow-1">
    <input class="form-control flex-grow-1" placeholder="Search Room, Guest, BookedBy" @bind="SearchText" @bind:event="oninput" style="min-width:300px;" />
    <button class="btn btn-outline-primary" @onclick="ApplySearch">Search</button>
    <button class="btn btn-outline-secondary" @onclick="ClearFilters">Clear Filters</button>

    <!-- Export buttons inline -->
    <button class="btn btn-success" @onclick="ExportExcelClient">Export Excel</button>
    <button class="btn btn-danger" @onclick="ExportPdfClient">Export PDF</button>
</div>


</div>

@if (FilteredBookings.Any())
{
    <SfGrid @ref="Grid" DataSource="@FilteredBookings" AllowPaging="true" AllowSorting="true" AllowFiltering="true">

        <GridPageSettings PageSize="10"></GridPageSettings>
        <GridColumns>
            <GridColumn Field="BookingId" HeaderText="Booking ID" Width="100" TextAlign="TextAlign.Center"></GridColumn>
            <GridColumn Field="RoomNo" HeaderText="Room No" Width="120"></GridColumn>
            <GridColumn Field="RoomType" HeaderText="Room Type" Width="150"></GridColumn>
            <GridColumn Field="GuestName" HeaderText="Guest Name" Width="200"></GridColumn>
            <GridColumn Field="GuestEmail" HeaderText="Guest Email" Width="220"></GridColumn>
            <GridColumn Field="StayedGuestCount" HeaderText="Stayed Guests" Width="150" TextAlign="TextAlign.Center"></GridColumn>
            <GridColumn Field="DurationOfStay" HeaderText="Duration (Days)" Width="150" TextAlign="TextAlign.Center"></GridColumn>
            <!-- âœ… Add these two new columns -->
            <GridColumn Field="CheckIn" HeaderText="Check In" Width="150" Format="dd-MM-yyyy" TextAlign="TextAlign.Center"></GridColumn>
            <GridColumn Field="CheckOut" HeaderText="Check Out" Width="150" Format="dd-MM-yyyy" TextAlign="TextAlign.Center"></GridColumn>
            <GridColumn Field="BookedBy" HeaderText="Booked By" Width="120"></GridColumn>
        </GridColumns>
    </SfGrid>

}
else
{
    <p class="text-muted mt-3">No bookings found for the selected filters.</p>
}

<style>
    .toolbar .btn {
        transition: all 0.2s ease;
    }
    .toolbar .btn:hover {
        transform: translateY(-2px);
    }
</style>

@code {
    private List<Booking> Bookings = new();
    private List<Booking> FilteredBookings = new();

    private SfGrid<Booking>? Grid;

    private string SearchText { get; set; } = "";
    private bool IsCustomRange { get; set; } = false;
    private bool IsMonthYearFilter { get; set; } = false;
    private DateTime? CustomStart { get; set; }
    private DateTime? CustomEnd { get; set; }

    private int SelectedMonth { get; set; } = DateTime.Now.Month;
    private int SelectedYear { get; set; } = DateTime.Now.Year;

    protected override void OnInitialized()
    {
        // sample data
        Bookings = new List<Booking>
{
    new Booking { BookingId=1, RoomNo="101", RoomType="Single", GuestName="John Doe", GuestEmail="john@mail.com", StayedGuestCount=1, DurationOfStay=3, BookedBy="HR", CheckIn=new DateTime(2025,9,12), CheckOut=new DateTime(2025,9,12).AddDays(3) },
    new Booking { BookingId=2, RoomNo="102", RoomType="Double", GuestName="Alice Smith", GuestEmail="alice@mail.com", StayedGuestCount=2, DurationOfStay=5, BookedBy="Admin", CheckIn=new DateTime(2025,9,15), CheckOut=new DateTime(2025,9,15).AddDays(5) },
    new Booking { BookingId=3, RoomNo="103", RoomType="Single", GuestName="Bob Johnson", GuestEmail="bob@mail.com", StayedGuestCount=1, DurationOfStay=2, BookedBy="HR", CheckIn=new DateTime(2025,9,10), CheckOut=new DateTime(2025,9,12) },
    new Booking { BookingId=4, RoomNo="104", RoomType="Double", GuestName="Carol White", GuestEmail="carol@mail.com", StayedGuestCount=2, DurationOfStay=4, BookedBy="Admin", CheckIn=new DateTime(2025,9,18), CheckOut=new DateTime(2025,9,22) },
    new Booking { BookingId=5, RoomNo="105", RoomType="Suite", GuestName="David Brown", GuestEmail="david@mail.com", StayedGuestCount=3, DurationOfStay=6, BookedBy="HR", CheckIn=new DateTime(2025,9,20), CheckOut=new DateTime(2025,9,26) },
    new Booking { BookingId=6, RoomNo="106", RoomType="Single", GuestName="Emma Davis", GuestEmail="emma@mail.com", StayedGuestCount=1, DurationOfStay=3, BookedBy="Admin", CheckIn=new DateTime(2025,9,22), CheckOut=new DateTime(2025,9,25) },
    new Booking { BookingId=7, RoomNo="107", RoomType="Double", GuestName="Frank Wilson", GuestEmail="frank@mail.com", StayedGuestCount=2, DurationOfStay=5, BookedBy="HR", CheckIn=new DateTime(2025,9,25), CheckOut=new DateTime(2025,9,30) },
    new Booking { BookingId=8, RoomNo="108", RoomType="Suite", GuestName="Grace Lee", GuestEmail="grace@mail.com", StayedGuestCount=3, DurationOfStay=7, BookedBy="Admin", CheckIn=new DateTime(2025,9,28), CheckOut=new DateTime(2025,10,5) },
    new Booking { BookingId=9, RoomNo="109", RoomType="Single", GuestName="Henry King", GuestEmail="henry@mail.com", StayedGuestCount=1, DurationOfStay=2, BookedBy="HR", CheckIn=new DateTime(2025,10,1), CheckOut=new DateTime(2025,10,3) },
    new Booking { BookingId=10, RoomNo="110", RoomType="Double", GuestName="Isla Scott", GuestEmail="isla@mail.com", StayedGuestCount=2, DurationOfStay=4, BookedBy="Admin", CheckIn=new DateTime(2025,10,3), CheckOut=new DateTime(2025,10,7) },
    new Booking { BookingId=11, RoomNo="111", RoomType="Suite", GuestName="Jack Hill", GuestEmail="jack@mail.com", StayedGuestCount=3, DurationOfStay=5, BookedBy="HR", CheckIn=new DateTime(2025,10,5), CheckOut=new DateTime(2025,10,10) },
    new Booking { BookingId=12, RoomNo="112", RoomType="Single", GuestName="Kara Green", GuestEmail="kara@mail.com", StayedGuestCount=1, DurationOfStay=3, BookedBy="Admin", CheckIn=new DateTime(2025,10,8), CheckOut=new DateTime(2025,10,11) },
    new Booking { BookingId=13, RoomNo="113", RoomType="Double", GuestName="Liam Young", GuestEmail="liam@mail.com", StayedGuestCount=2, DurationOfStay=4, BookedBy="HR", CheckIn=new DateTime(2025,10,10), CheckOut=new DateTime(2025,10,14) },
    new Booking { BookingId=14, RoomNo="114", RoomType="Suite", GuestName="Mia Adams", GuestEmail="mia@mail.com", StayedGuestCount=3, DurationOfStay=6, BookedBy="Admin", CheckIn=new DateTime(2025,10,12), CheckOut=new DateTime(2025,10,18) },
    new Booking { BookingId=15, RoomNo="115", RoomType="Single", GuestName="Noah Baker", GuestEmail="noah@mail.com", StayedGuestCount=1, DurationOfStay=2, BookedBy="HR", CheckIn=new DateTime(2025,10,15), CheckOut=new DateTime(2025,10,17) },
    new Booking { BookingId=16, RoomNo="116", RoomType="Double", GuestName="Olivia Carter", GuestEmail="olivia@mail.com", StayedGuestCount=2, DurationOfStay=5, BookedBy="Admin", CheckIn=new DateTime(2025,10,18), CheckOut=new DateTime(2025,10,23) }
};


        FilteredBookings = Bookings.ToList();
    }

    private void PeriodChanged(ChangeEventArgs e)
    {
        var value = e.Value?.ToString();
        IsCustomRange = value == "Custom";
        IsMonthYearFilter = value == "Month" || value == "Year";

        switch (value)
        {
            case "All":
                FilteredBookings = Bookings.ToList();
                break;
            case "Month":
            case "Year":
                ApplyMonthYearFilter();
                break;
        }
    }

    private void ApplyMonthYearFilter()
    {
        if (IsMonthYearFilter)
        {
            FilteredBookings = Bookings.Where(b =>
                b.CheckIn.HasValue &&
                b.CheckIn.Value.Month == SelectedMonth &&
                b.CheckIn.Value.Year == SelectedYear
            ).ToList();
        }
    }

    private void ApplyCustomRange()
    {
        if (CustomStart.HasValue && CustomEnd.HasValue)
        {
            FilteredBookings = Bookings.Where(b =>
                b.CheckIn.HasValue &&
                b.CheckIn.Value.Date >= CustomStart.Value.Date &&
                b.CheckIn.Value.Date <= CustomEnd.Value.Date
            ).ToList();
        }
    }

    private void ApplySearch()
    {
        if (string.IsNullOrWhiteSpace(SearchText))
        {
            FilteredBookings = Bookings.ToList();
        }
        else
        {
            FilteredBookings = FilteredBookings.Where(b =>
                (b.RoomNo?.Contains(SearchText, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (b.RoomType?.Contains(SearchText, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (b.GuestName?.Contains(SearchText, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (b.BookedBy?.Contains(SearchText, StringComparison.OrdinalIgnoreCase) ?? false)
            ).ToList();
        }
    }

    private void ClearFilters()
    {
        FilteredBookings = Bookings.ToList();
        SearchText = "";
        IsCustomRange = false;
        IsMonthYearFilter = false;
        CustomStart = null;
        CustomEnd = null;
        SelectedMonth = DateTime.Now.Month;
        SelectedYear = DateTime.Now.Year;
    }
private async Task ExportExcelClient()
{
    if (Grid != null)
    {
       var records = await Grid.GetFilteredRecordsAsync();
       var data = (records as IEnumerable<object>)?.OfType<Booking>().ToList() ?? new List<Booking>();



        if (data.Any())
        {
            var exportData = data.Select(b => new {
                b.BookingId,
                b.RoomNo,
                b.RoomType,
                b.GuestName,
                b.GuestEmail,
                b.StayedGuestCount,
                b.DurationOfStay,
                CheckIn = b.CheckIn?.ToString("dd-MM-yyyy"),
                CheckOut = b.CheckOut?.ToString("dd-MM-yyyy"),
                b.BookedBy
            });

            await JS.InvokeVoidAsync("exportToExcel", exportData, "MISReport.xlsx");
        }
    }
}

    private async Task ExportPdfClient()
    {
        if (Grid != null)
    {
       var records = await Grid.GetFilteredRecordsAsync();
       var data = (records as IEnumerable<object>)?.OfType<Booking>().ToList() ?? new List<Booking>();



        if (data.Any())
        {
            var exportData = data.Select(b => new {
                b.BookingId,
                b.RoomNo,
                b.RoomType,
                b.GuestName,
                b.GuestEmail,
                b.StayedGuestCount,
                b.DurationOfStay,
                CheckIn = b.CheckIn?.ToString("dd-MM-yyyy"),
                CheckOut = b.CheckOut?.ToString("dd-MM-yyyy"),
                b.BookedBy
            });

            await JS.InvokeVoidAsync("exportToPDF", exportData, "MISReport.pdf");
        }
    }
    }

    public class Booking
    {
        public int BookingId { get; set; }
        public string RoomNo { get; set; } = string.Empty;
        public string RoomType { get; set; } = string.Empty;
        public string GuestName { get; set; } = string.Empty;
        public string GuestEmail { get; set; } = string.Empty;
        public int StayedGuestCount { get; set; }
        public DateTime? CheckIn { get; set; }
        public DateTime? CheckOut { get; set; } 
        public int DurationOfStay { get; set; }
        public string BookedBy { get; set; } = string.Empty;
    }
}
