@page "/bookings"
@using Syncfusion.Blazor.Grids
@using System.Globalization

<PageTitle>Bookings</PageTitle>

<div class="toolbar mb-3 d-flex flex-wrap align-items-center gap-2">
    <!-- Period selection -->
    <div class="d-flex gap-2 align-items-center">
        <select class="form-select" style="width:180px;" @onchange="PeriodChanged">
            <option value="All">All</option>
            <option value="Month">This Month</option>
            <option value="Year">This Year</option>
            <option value="Custom">Custom Range</option>
        </select>

        @if (IsCustomRange)
        {
            <InputDate @bind-Value="CustomStart" class="form-control" style="width:150px;" />
            <InputDate @bind-Value="CustomEnd" class="form-control" style="width:150px;" />
            <button class="btn btn-outline-primary" @onclick="ApplyCustomRange">Apply</button>
        }
        else if (IsMonthYearFilter)
        {
            <select class="form-select" style="width:160px;" @bind="SelectedMonth">
                @for (int m = 1; m <= 12; m++)
                {
                    <option value="@m">@CultureInfo.CurrentCulture.DateTimeFormat.GetMonthName(m)</option>
                }
            </select>
            <select class="form-select" style="width:100px;" @bind="SelectedYear">
                @for (int y = 2023; y <= DateTime.Now.Year + 2; y++)
                {
                    <option value="@y">@y</option>
                }
            </select>
            <button class="btn btn-outline-primary" @onclick="ApplyMonthYearFilter">Apply</button>
        }
    </div>

    <!-- Search -->
    <div class="d-flex gap-2 align-items-center flex-grow-1">
        <input class="form-control" placeholder="Search RoomNo, Type, BookedBy" @bind="SearchText" @bind:event="oninput" />
        <button class="btn btn-outline-primary" @onclick="ApplySearch">Search</button>
    </div>

    <!-- Actions -->
    <div class="d-flex gap-2">
        <button class="btn btn-outline-secondary" @onclick="ClearFilters">Clear Filters</button>
    </div>
</div>

<SfGrid DataSource="@FilteredBookings" AllowPaging="true" AllowSorting="true" AllowFiltering="true">
    <GridPageSettings PageSize="5"></GridPageSettings>
    <GridColumns>
        <GridColumn Field="RoomNo" HeaderText="Room No" Width="100" TextAlign="TextAlign.Center"></GridColumn>
        <GridColumn Field="Type" HeaderText="Type" Width="120" TextAlign="TextAlign.Center"></GridColumn>
        <GridColumn Field="Capacity" HeaderText="Capacity" Width="100" TextAlign="TextAlign.Center"></GridColumn>
        <GridColumn Field="Status" HeaderText="Status" Width="120" TextAlign="TextAlign.Center">
            <Template>
                @{
                    var status = (context as Booking)?.Status;
                    string color = status == "Occupied" ? "red" :
                                   status == "Available" ? "green" :
                                   status == "Maintenance" ? "orange" : "gray";
                }
                <span style="font-weight:bold;color:@color">@status</span>
            </Template>
        </GridColumn>
        <GridColumn Field="BookedBy" HeaderText="Booked By" Width="120" TextAlign="TextAlign.Center"></GridColumn>
        <GridColumn Field="CheckIn" HeaderText="Check-In" Width="120" TextAlign="TextAlign.Center" Format="dd MMM yyyy">
            <Template>
                @{
                    var date = (context as Booking)?.CheckIn;
                    var today = DateTime.Today;
                    string bgColor = date.HasValue && date.Value.Date == today ? "#FFF3CD" : "transparent";
                }
                <span style="background-color:@bgColor; padding:2px 4px; border-radius:3px;">
                    @(date?.ToString("dd MMM yyyy") ?? "-")
                </span>
            </Template>
        </GridColumn>
        <GridColumn Field="CheckOut" HeaderText="Check-Out" Width="120" TextAlign="TextAlign.Center" Format="dd MMM yyyy">
            <Template>
                @( (context as Booking)?.CheckOut?.ToString("dd MMM yyyy") ?? "-" )
            </Template>
        </GridColumn>
        <GridColumn Field="Remarks" HeaderText="Remarks" Width="100" TextAlign="TextAlign.Center"></GridColumn>
    </GridColumns>
</SfGrid>

@code {
    private string SearchText { get; set; } = "";
    private bool IsCustomRange { get; set; } = false;
    private bool IsMonthYearFilter { get; set; } = false;
    private DateTime? CustomStart { get; set; }
    private DateTime? CustomEnd { get; set; }

    private int SelectedMonth { get; set; } = DateTime.Now.Month;
    private int SelectedYear { get; set; } = DateTime.Now.Year;

    private List<Booking> Bookings = new()
    {
        new Booking{ RoomNo="001", Type="Single", Capacity="01", Status="Occupied", BookedBy="Richard", CheckIn=new DateTime(2025,9,12), CheckOut=new DateTime(2025,9,13), Remarks="NIL"},
        new Booking{ RoomNo="002", Type="Single", Capacity="01", Status="Occupied", BookedBy="Richard", CheckIn=new DateTime(2025,9,15), CheckOut=new DateTime(2025,9,16), Remarks="NIL"},
        new Booking{ RoomNo="003", Type="Double", Capacity="02", Status="Occupied", BookedBy="Peter", CheckIn=new DateTime(2025,8,20), CheckOut=new DateTime(2025,8,21), Remarks="NIL"},
        new Booking{ RoomNo="004", Type="Double", Capacity="02", Status="Available", BookedBy="", CheckIn=null, CheckOut=null, Remarks="NIL"},
    };

    private List<Booking> FilteredBookings;

    protected override void OnInitialized()
    {
        FilteredBookings = Bookings.ToList();
    }

    private void PeriodChanged(ChangeEventArgs e)
    {
        var value = e.Value?.ToString();
        IsCustomRange = value == "Custom";
        IsMonthYearFilter = value == "Month" || value == "Year";

        switch (value)
        {
            case "All":
                FilteredBookings = Bookings.ToList();
                break;
            case "Month":
            case "Year":
                ApplyMonthYearFilter();
                break;
        }
    }

    private void ApplyMonthYearFilter()
    {
        if (IsMonthYearFilter)
        {
            FilteredBookings = Bookings.Where(b =>
                b.CheckIn.HasValue &&
                b.CheckIn.Value.Month == SelectedMonth &&
                b.CheckIn.Value.Year == SelectedYear
            ).ToList();
        }
    }

    private void ApplyCustomRange()
    {
        if (CustomStart.HasValue && CustomEnd.HasValue)
        {
            FilteredBookings = Bookings.Where(b =>
                b.CheckIn.HasValue &&
                b.CheckIn.Value.Date >= CustomStart.Value.Date &&
                b.CheckIn.Value.Date <= CustomEnd.Value.Date
            ).ToList();
        }
    }

    private void ApplySearch()
    {
        if (string.IsNullOrWhiteSpace(SearchText))
        {
            FilteredBookings = Bookings.ToList();
        }
        else
        {
            FilteredBookings = FilteredBookings.Where(b =>
                (b.RoomNo != null && b.RoomNo.Contains(SearchText, StringComparison.OrdinalIgnoreCase)) ||
                (b.Type != null && b.Type.Contains(SearchText, StringComparison.OrdinalIgnoreCase)) ||
                (b.BookedBy != null && b.BookedBy.Contains(SearchText, StringComparison.OrdinalIgnoreCase))
            ).ToList();
        }
    }

    private void ClearFilters()
    {
        FilteredBookings = Bookings.ToList();
        SearchText = "";
        IsCustomRange = false;
        IsMonthYearFilter = false;
        CustomStart = null;
        CustomEnd = null;
        SelectedMonth = DateTime.Now.Month;
        SelectedYear = DateTime.Now.Year;
    }

    public class Booking
    {
        public string RoomNo { get; set; } = "";
        public string Type { get; set; } = "";
        public string Capacity { get; set; } = "";
        public string Status { get; set; } = "";
        public string BookedBy { get; set; } = "";
        public DateTime? CheckIn { get; set; }
        public DateTime? CheckOut { get; set; }
        public string Remarks { get; set; } = "";
    }
}
